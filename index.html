<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claro - Your Financial Clarity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .tab-active {
            background-color: #4f46e5;
            color: white;
        }
        .tab-inactive {
            background-color: #e0e7ff;
            color: #4338ca;
        }
        .setting-btn-active {
            background-color: #4f46e5;
            color: white;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: auto;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .spinner {
            border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dark Mode Styles */
        .dark body {
            background-color: #111827;
            color: #d1d5db;
        }
        .dark .bg-white {
            background-color: #1f2937;
            border-color: #374151;
        }
        .dark .text-gray-800, .dark .text-gray-900 {
            color: #f9fafb;
        }
        .dark .text-gray-500, .dark .text-gray-600 {
            color: #9ca3af;
        }
        .dark .border-gray-200 {
            border-color: #374151;
        }
        .dark input, .dark select {
            background-color: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }
        .dark input::placeholder {
            color: #9ca3af;
        }
        .dark .bg-gray-200 { background-color: #374151; }
        .dark .bg-indigo-100 { background-color: #3730a3; }
        .dark .tab-inactive { background-color: #374151; color: #a5b4fc; }
        .dark .setting-btn-inactive { background-color: #374151; color: #a5b4fc; }
        .dark #monthly-chart { color: #f9fafb; }
        .dark .chartjs-legend-text { color: #f9fafb; }
        .dark text { fill: #f9fafb; }
        .dark .setting-btn-active {
            background-color: #4f46e5;
            color: white;
        }
        .dark .dark\:text-gray-300 {
            color: #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    
    <!-- Onboarding View -->
    <div id="onboarding-view" class="max-w-xl mx-auto p-6 min-h-screen flex items-center hidden">
        <div class="w-full bg-white p-8 rounded-2xl shadow-lg border border-gray-200">
            <h1 class="text-3xl font-bold text-center mb-2">Welcome to Claro</h1>
            <p class="text-center text-gray-600 mb-6">Let's set up your financial profile to get started.</p>
            <form id="onboarding-form" class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="onboarding-name" class="block text-sm font-medium">Full Name</label>
                        <input type="text" id="onboarding-name" placeholder="e.g., Ivan Horvat" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                     <div>
                        <label for="onboarding-currency" data-lang="currency" class="block text-sm font-medium">Currency</label>
                        <select id="onboarding-currency" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="EUR">EUR (€)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">Your Budget Rule</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="onboarding-needs-slider" class="block text-sm font-medium">Needs (<span id="onboarding-needs-slider-val">50</span>%)</label>
                            <input id="onboarding-needs-slider" type="range" min="0" max="100" value="50" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label for="onboarding-wants-slider" class="block text-sm font-medium">Wants (<span id="onboarding-wants-slider-val">30</span>%)</label>
                            <input id="onboarding-wants-slider" type="range" min="0" max="100" value="30" class="w-full h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label for="onboarding-savings-slider" class="block text-sm font-medium">Savings (<span id="onboarding-savings-slider-val">20</span>%)</label>
                            <input id="onboarding-savings-slider" type="range" min="0" max="100" value="20" class="w-full h-2 bg-green-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <p id="onboarding-slider-total" class="text-sm font-bold text-center text-gray-700">Total: 100%</p>
                        <p id="onboarding-habit-tip" class="text-xs text-gray-500 text-center mt-4 italic"></p>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold mb-2">Your Primary Financial Goal</h3>
                    <p class="text-xs text-gray-500 mb-2 italic">A clear goal will help the AI provide you with a more accurate financial plan.</p>
                     <div class="grid grid-cols-1 gap-4">
                         <div>
                            <label for="onboarding-goal-select" class="block text-sm font-medium">Goal</label>
                            <select id="onboarding-goal-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                <option data-lang="goal_wealth">Build Wealth</option>
                                <option data-lang="goal_safety">Create a Safety Net</option>
                                <option data-lang="goal_trip">Save for a Dream Trip</option>
                                <option data-lang="goal_car">Save for a New Car</option>
                                <option data-lang="goal_home">Save for a Home</option>
                                <option value="custom" data-lang="goal_custom">Custom...</option>
                            </select>
                            <input type="text" id="onboarding-goal-desc" placeholder="e.g., Trip to Italy" class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md hidden">
                        </div>
                        <div>
                            <label for="onboarding-goal-amount" data-lang="amount" class="block text-sm font-medium">Amount</label>
                            <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="onboarding-goal-amount" placeholder="5000" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
                <div id="onboarding-error" class="text-red-500 text-sm text-center h-4 mb-2"></div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700">Start Tracking</button>
            </form>
        </div>
    </div>

    <!-- Main App View -->
    <div id="app-view" class="max-w-4xl mx-auto p-4 sm:p-6 hidden">
         <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Claro</h1>
                <p id="welcome-message" class="text-gray-600 text-sm">Welcome back!</p>
            </div>
            <div>
                 <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                 </button>
            </div>
        </header>
        
        <main id="main-content" class="space-y-6">
            <!-- Summary Section -->
            <section id="summary" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 data-lang="total_income" class="font-semibold text-gray-500">Total Income</h3>
                    <p id="total-income" class="text-2xl sm:text-3xl font-bold text-green-600 mt-2">€0.00</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 data-lang="total_expenses" class="font-semibold text-gray-500">Total Expenses</h3>
                    <p id="total-expenses" class="text-2xl sm:text-3xl font-bold text-red-600 mt-2">€0.00</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <h3 data-lang="balance" class="font-semibold text-gray-500">Balance</h3>
                    <p id="balance" class="text-2xl sm:text-3xl font-bold text-indigo-600 mt-2">€0.00</p>
                </div>
            </section>

            <!-- Custom Budget Rule Section -->
            <section id="budget-rule" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h2 data-lang="budget_breakdown" class="text-2xl font-bold mb-4">Your Budget Breakdown</h2>
                <div class="space-y-5">
                     <div>
                        <div class="flex justify-between items-center mb-1">
                            <h4 id="needs-title" class="font-semibold text-lg">Needs (50%)</h4>
                            <span id="needs-summary" class="text-sm font-medium text-gray-600 flex items-center"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4"><div id="needs-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        <p id="needs-progress" class="text-xs text-gray-500 text-right mt-1"></p>
                    </div>
                     <div>
                        <div class="flex justify-between items-center mb-1">
                            <h4 id="wants-title" class="font-semibold text-lg">Wants (30%)</h4>
                            <span id="wants-summary" class="text-sm font-medium text-gray-600 flex items-center"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4"><div id="wants-bar" class="bg-purple-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        <p id="wants-progress" class="text-xs text-gray-500 text-right mt-1"></p>
                    </div>
                     <div>
                        <div class="flex justify-between items-center mb-1">
                            <h4 id="savings-title" class="font-semibold text-lg">Savings (20%)</h4>
                            <span id="savings-summary" class="text-sm font-medium text-gray-600 flex items-center"></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4"><div id="savings-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        <p id="savings-progress" class="text-xs text-gray-500 text-right mt-1"></p>
                    </div>
                </div>
            </section>

             <!-- AI Financial Plan Section -->
             <section id="tips-section" class="bg-indigo-50 dark:bg-indigo-900/20 border-l-4 border-indigo-500 p-4 rounded-r-lg">
                <h3 data-lang="ai_financial_plan" class="text-lg font-bold text-indigo-800 dark:text-indigo-300">Your AI Financial Plan</h3>
                <div id="tips-content" class="mt-2 text-indigo-700 dark:text-indigo-400 text-sm"></div>
            </section>

            <!-- Add Transaction Section -->
            <section id="add-transaction" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h2 data-lang="add_transaction" class="text-2xl font-bold mb-4">Add Transaction</h2>
                <form id="transaction-form">
                    <div class="flex justify-center rounded-lg p-1 bg-indigo-100 mb-4">
                        <button type="button" id="type-income" data-lang="income" class="w-full py-2 px-4 rounded-md text-sm font-semibold transition-colors duration-300 tab-active">Income</button>
                        <button type="button" id="type-expense" data-lang="expense" class="w-full py-2 px-4 rounded-md text-sm font-semibold transition-colors duration-300 tab-inactive">Expense</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="description" data-lang="description" class="block text-sm font-medium text-gray-700">Description</label>
                            <input type="text" id="description" data-lang-placeholder="description_placeholder" placeholder="e.g., Salary, Groceries" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="amount" data-lang="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="amount" placeholder="0.00" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div id="expense-fields-wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 hidden">
                        <div>
                            <label for="rule-category" data-lang="budget_category" class="block text-sm font-medium text-gray-700">Budget Category</label>
                            <select id="rule-category" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <option value="Needs" data-lang="need_option">Need</option>
                                <option value="Wants" data-lang="want_option">Want</option>
                                <option value="Savings" data-lang="saving_option">Saving</option>
                            </select>
                        </div>
                        <div>
                            <label for="category" data-lang="sub_category" class="block text-sm font-medium text-gray-700">Sub-Category</label>
                            <select id="category" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                        </div>
                    </div>
                    
                    <!-- Recurring Expense Toggle -->
                    <div id="recurring-toggle-add-wrapper" class="hidden">
                        <div class="flex items-center justify-between mt-4">
                            <label for="recurring-toggle-add" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="recurring_expense">Recurring Expense</label>
                            <label class="inline-flex relative items-center cursor-pointer">
                                <input type="checkbox" id="recurring-toggle-add" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                        <div id="recurring-day-add-wrapper" class="hidden mt-2">
                            <label for="recurring-day-add" class="block text-sm font-medium text-gray-700" data-lang="day_of_month">Day of Month (1-31)</label>
                            <select id="recurring-day-add" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                <!-- Options 1-31 will be added by JS -->
                            </select>
                        </div>
                    </div>

                    <button type="submit" data-lang="add_transaction_btn" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">Add Transaction</button>
                </form>
            </section>
            
            <!-- Transaction History -->
            <section id="transaction-history">
                <h2 data-lang="recent_transactions" class="text-2xl font-bold mb-4">Recent Transactions</h2>
                <div id="transaction-list" class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                   <div id="empty-state" class="text-center p-8"><p data-lang="no_transactions" class="text-gray-500">No transactions yet for this month.</p></div>
                </div>
            </section>

            <!-- Monthly Review Section -->
            <section id="monthly-review-section" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 data-lang="monthly_review" class="text-2xl font-bold">Monthly Review</h2>
                    <select id="month-selector" class="pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                </div>
                <div id="monthly-review-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div>
                        <h3 id="review-title" class="text-xl font-semibold mb-3"></h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span data-lang="total_income">Total Income:</span><span id="review-income" class="font-medium"></span></div>
                            <div class="flex justify-between"><span data-lang="total_expenses">Total Expenses:</span><span id="review-expenses" class="font-medium"></span></div>
                            <div class="flex justify-between"><span data-lang="net_savings">Net Savings:</span><span id="review-savings" class="font-medium"></span></div>
                        </div>
                        <div id="review-ai-advice" class="mt-4 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg text-indigo-800 dark:text-indigo-300"></div>
                    </div>
                    <div>
                        <canvas id="monthly-chart"></canvas>
                    </div>
                </div>
                 <div id="no-review-data" class="text-center p-8 text-gray-500 hidden"><p data-lang="no_review_data">No data available for this month.</p></div>
            </section>
        </main>
    </div>
    
    <!-- Edit Transaction Modal -->
    <div id="edit-transaction-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-content bg-white w-11/12 sm:max-w-md mx-auto rounded-2xl shadow-lg z-50 p-6 transform -translate-y-64">
             <div class="flex justify-between items-center pb-3">
                <h2 data-lang="edit_transaction" class="text-2xl font-bold">Edit Transaction</h2>
                <button id="close-edit-transaction-modal" class="cursor-pointer z-50 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 text-2xl">&times;</button>
            </div>
            <form id="edit-transaction-form">
                <input type="hidden" id="edit-transaction-id">
                <div class="space-y-4">
                    <div class="relative">
                        <label for="edit-description" data-lang="description" class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" id="edit-description" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                         <label for="edit-amount" data-lang="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="edit-amount" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div id="edit-expense-fields-wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                         <label for="edit-rule-category" data-lang="budget_category" class="block text-sm font-medium text-gray-700">Budget Category</label>
                         <select id="edit-rule-category" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="Needs" data-lang="need_option">Need</option>
                            <option value="Wants" data-lang="want_option">Want</option>
                            <option value="Savings" data-lang="saving_option">Saving</option>
                         </select>
                    </div>
                     <div>
                         <label for="edit-category" data-lang="sub_category" class="block text-sm font-medium text-gray-700">Sub-Category</label>
                         <select id="edit-category" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                         </select>
                    </div>
                </div>

                <!-- Recurring Expense Toggle -->
                <div id="recurring-toggle-edit-wrapper" class="hidden">
                    <div class="flex items-center justify-between mt-4">
                        <label for="recurring-toggle-edit" class="text-sm font-medium text-gray-700 dark:text-gray-300" data-lang="recurring_expense">Recurring Expense</label>
                        <label class="inline-flex relative items-center cursor-pointer">
                            <input type="checkbox" id="recurring-toggle-edit" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-indigo-600"></div>
                        </label>
                    </div>
                    <div id="recurring-day-edit-wrapper" class="hidden mt-2">
                        <label for="recurring-day-edit" class="block text-sm font-medium text-gray-700" data-lang="day_of_month">Day of Month (1-31)</label>
                        <select id="recurring-day-edit" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                           <!-- Options 1-31 will be added by JS -->
                        </select>
                    </div>
                </div>

                <button type="submit" data-lang="save_changes_btn" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-content bg-white w-11/12 sm:max-w-md mx-auto rounded-2xl shadow-lg z-50 p-6 transform -translate-y-64">
            <div class="flex justify-between items-center pb-3">
                <p data-lang="settings" class="text-2xl font-bold">Settings</p>
                <button id="close-settings-modal" class="cursor-pointer z-50 p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">&times;</button>
            </div>
            
            <div id="settings-content">
                <h3 data-lang="appearance" class="text-lg font-semibold mb-2">Appearance</h3>
                <div class="space-y-2">
                    <label data-lang="theme" class="block text-sm font-medium">Theme</label>
                    <div class="flex rounded-lg p-1 bg-gray-200 dark:bg-gray-700">
                        <button type="button" id="theme-light-btn" class="theme-btn w-full py-2 px-4 rounded-md text-sm font-semibold dark:text-gray-300" data-theme="light" data-lang="light">Light</button>
                        <button type="button" id="theme-dark-btn" class="theme-btn w-full py-2 px-4 rounded-md text-sm font-semibold dark:text-gray-300" data-theme="dark" data-lang="dark">Dark</button>
                    </div>
                </div>
                <div class="space-y-2 mt-4">
                    <label data-lang="language" class="block text-sm font-medium">Language</label>
                    <div class="flex rounded-lg p-1 bg-gray-200 dark:bg-gray-700">
                        <button type="button" id="lang-en-btn" class="lang-btn w-full py-2 px-4 rounded-md text-sm font-semibold dark:text-gray-300" data-lang-set="en">English</button>
                        <button type="button" id="lang-hr-btn" class="lang-btn w-full py-2 px-4 rounded-md text-sm font-semibold dark:text-gray-300" data-lang-set="hr">Hrvatski</button>
                    </div>
                </div>
                 <div class="space-y-2 mt-4">
                    <label data-lang="currency" class="block text-sm font-medium">Currency</label>
                    <div class="flex rounded-lg p-1 bg-gray-200 dark:bg-gray-700">
                        <button type="button" id="currency-eur-btn" class="currency-btn w-full py-2 px-4 rounded-md text-sm font-semibold dark:text-gray-300" data-currency="EUR">EUR (€)</button>
                        <button type="button" id="currency-usd-btn" class="currency-btn w-full py-2 px-4 rounded-md text-sm font-semibold dark:text-gray-300" data-currency="USD">USD ($)</button>
                    </div>
                </div>
                 <div class="space-y-2 mt-4">
                    <label data-lang="privacy" class="block text-sm font-medium">Privacy</label>
                    <div class="flex rounded-lg p-1 bg-gray-200 dark:bg-gray-700">
                        <button type="button" id="privacy-on-btn" class="privacy-btn w-full py-2 px-4 rounded-md text-sm font-semibold dark:text-gray-300" data-privacy-mode="true" data-lang="privacy_on">On</button>
                        <button type="button" id="privacy-off-btn" class="privacy-btn w-full py-2 px-4 rounded-md text-sm font-semibold dark:text-gray-300" data-privacy-mode="false" data-lang="privacy_off">Off</button>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                    <h3 data-lang="manage_recurring" class="text-lg font-semibold mb-2">Manage Recurring Expenses</h3>
                    <div id="recurring-list-container" class="mt-4 max-h-40 overflow-y-auto space-y-2">
                        <!-- Recurring expenses will be listed here -->
                    </div>
                </div>
                
                <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6 flex justify-end">
                     <button id="reset-app-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Reset App Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- App Config ---
            const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
            const apiKey = ""; // This will be provided by the Canvas environment automatically.

            // --- Translations ---
            const translations = {
                en: {
                    total_income: 'Total Income', total_expenses: 'Total Expenses', balance: 'Balance',
                    budget_breakdown: 'Your Budget Breakdown', needs: 'Needs', wants: 'Wants', savings: 'Savings',
                    ai_financial_plan: 'Your AI Financial Plan', add_transaction: 'Add Transaction',
                    motivational_quote: '"Take 5 minutes daily to track your expenses. 5 minutes today can drastically change your future self."',
                    income: 'Income', expense: 'Expense', description: 'Description', description_placeholder: 'e.g., Salary, Groceries',
                    amount: 'Amount', budget_category: 'Budget Category', need_option: 'Need', want_option: 'Want', saving_option: 'Saving',
                    sub_category: 'Sub-Category', check_categories_helper: 'Please select the correct categories for your expense.',
                    add_transaction_btn: 'Add Transaction', recent_transactions: 'Recent Transactions', no_transactions: 'No transactions yet for this month.',
                    monthly_review: 'Monthly Review', review_for: 'Review for', net_savings: 'Net Savings', no_review_data: 'No data available for this month.',
                    settings: 'Settings', customize_budget: 'Customize Your Budget Rule', set_financial_goal: 'Set Your Financial Goal',
                    goal: 'Goal', goal_placeholder: 'e.g., Vacation', save_settings: 'Save Settings', logout: 'Logout',
                    appearance: 'Appearance', theme: 'Theme', light: 'Light', dark: 'Dark', language: 'Language', welcome: 'Welcome, ', welcome_back: 'Welcome back, ',
                    privacy: 'Privacy', hide_amounts: 'Hide amounts', edit_transaction: 'Edit Transaction', save_changes_btn: 'Save Changes',
                    set_goal_prompt: 'Set a financial goal in your settings to get a personalized AI plan!',
                    privacy_on: 'On', privacy_off: 'Off', currency: 'Currency', quick_adds: 'Quick Adds',
                    progress: 'Progress',
                    goal_wealth: 'Build Wealth', goal_safety: 'Create a Safety Net', goal_trip: 'Save for a Dream Trip', goal_car: 'Save for a New Car', goal_home: 'Save for a Home', goal_custom: 'Custom...',
                    recurring_expense: 'Recurring Expense', day_of_month: 'Day of Month (1-31)', manage_recurring: 'Manage Recurring Expenses', no_recurring_expenses: 'No recurring expenses set up.',
                    next_payment_on: 'Next payment on'
                },
                hr: {
                    total_income: 'Ukupni Prihodi', total_expenses: 'Ukupni Troškovi', balance: 'Stanje',
                    budget_breakdown: 'Vaša Raspodjela Budžeta', needs: 'Potrebe', wants: 'Želje', savings: 'Štednja',
                    ai_financial_plan: 'Vaš AI Financijski Plan', add_transaction: 'Dodaj Transakciju',
                    motivational_quote: '"Uzmite 5 minuta dnevno za praćenje troškova. 5 minuta danas može drastično promijeniti vaše buduće ja."',
                    income: 'Prihod', expense: 'Trošak', description: 'Opis', description_placeholder: 'npr. Plaća, Namirnice',
                    amount: 'Iznos', budget_category: 'Kategorija Budžeta', need_option: 'Potreba', want_option: 'Želja', saving_option: 'Štednja',
                    sub_category: 'Potkategorija', check_categories_helper: 'Molimo odaberite ispravne kategorije za vaš trošak.',
                    add_transaction_btn: 'Dodaj Transakciju', recent_transactions: 'Nedavne Transakcije', no_transactions: 'Nema transakcija za ovaj mjesec.',
                    monthly_review: 'Mjesečni Pregled', review_for: 'Pregled za', net_savings: 'Neto Ušteda', no_review_data: 'Nema podataka za ovaj mjesec.',
                    settings: 'Postavke', customize_budget: 'Prilagodite Svoje Pravilo Budžetiranja', set_financial_goal: 'Postavite Svoj Financijski Cilj',
                    goal: 'Cilj', goal_placeholder: 'npr. Putovanje', save_settings: 'Spremi Postavke', logout: 'Odjava',
                    appearance: 'Izgled', theme: 'Tema', light: 'Svijetla', dark: 'Tamna', language: 'Jezik', welcome: 'Dobrodošli, ', welcome_back: 'Dobrodošli natrag, ',
                    privacy: 'Privatnost', hide_amounts: 'Sakrij iznose', edit_transaction: 'Uredi Transakciju', save_changes_btn: 'Spremi Promjene',
                    set_goal_prompt: 'Postavite financijski cilj u postavkama kako biste dobili personalizirani AI plan!',
                    privacy_on: 'Uključeno', privacy_off: 'Isključeno', currency: 'Valuta', quick_adds: 'Brzi Unosi',
                    progress: 'Napredak',
                    goal_wealth: 'Izgradi Bogatstvo', goal_safety: 'Stvori Sigurnosnu Mrežu', goal_trip: 'Štedi za Putovanje Iz Snova', goal_car: 'Štedi za Novi Auto', goal_home: 'Štedi za Dom', goal_custom: 'Prilagođeno...',
                    recurring_expense: 'Ponavljajući Trošak', day_of_month: 'Dan u mjesecu (1-31)', manage_recurring: 'Upravljaj Ponavljajućim Troškovima', no_recurring_expenses: 'Nema postavljenih ponavljajućih troškova.',
                    next_payment_on: 'Iduća uplata'
                }
            };
            
            const subCategoryMap = {
                Needs: ['Housing', 'Utilities', 'Groceries', 'Transport', 'Health', 'Debt Payments'],
                Wants: ['Dining Out', 'Entertainment', 'Shopping', 'Hobbies', 'Subscriptions', 'Vacation'],
                Savings: ['Emergency Fund', 'Investments', 'Retirement']
            };

            // --- DOM Elements ---
            const onboardingView = document.getElementById('onboarding-view');
            const appView = document.getElementById('app-view');
            const onboardingForm = document.getElementById('onboarding-form');
            const onboardingError = document.getElementById('onboarding-error');
            const onboardingCurrency = document.getElementById('onboarding-currency');
            const welcomeMessage = document.getElementById('welcome-message');
            const themeLightBtn = document.getElementById('theme-light-btn');
            const themeDarkBtn = document.getElementById('theme-dark-btn');
            const langEnBtn = document.getElementById('lang-en-btn');
            const langHrBtn = document.getElementById('lang-hr-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const transactionForm = document.getElementById('transaction-form');
            const descriptionInput = document.getElementById('description');
            const ruleCategoryInput = document.getElementById('rule-category');
            const categoryInput = document.getElementById('category');
            const typeIncomeBtn = document.getElementById('type-income');
            const typeExpenseBtn = document.getElementById('type-expense');
            const expenseFieldsWrapper = document.getElementById('expense-fields-wrapper');
            const transactionListEl = document.getElementById('transaction-list');
            const emptyState = document.getElementById('empty-state');
            const tipsSection = document.getElementById('tips-section');
            const tipsContent = document.getElementById('tips-content');
            const totalIncomeEl = document.getElementById('total-income'), totalExpensesEl = document.getElementById('total-expenses'), balanceEl = document.getElementById('balance');
            const needsTitleEl = document.getElementById('needs-title'), wantsTitleEl = document.getElementById('wants-title'), savingsTitleEl = document.getElementById('savings-title');
            const needsSummaryEl = document.getElementById('needs-summary'), wantsSummaryEl = document.getElementById('wants-summary'), savingsSummaryEl = document.getElementById('savings-summary');
            const needsBarEl = document.getElementById('needs-bar'), wantsBarEl = document.getElementById('wants-bar'), savingsBarEl = document.getElementById('savings-bar');
            const needsProgressEl = document.getElementById('needs-progress'), wantsProgressEl = document.getElementById('wants-progress'), savingsProgressEl = document.getElementById('savings-progress');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal');
            const monthlyReviewSection = document.getElementById('monthly-review-section');
            const monthSelector = document.getElementById('month-selector');
            const monthlyReviewContent = document.getElementById('monthly-review-content');
            const noReviewData = document.getElementById('no-review-data');
            const reviewTitle = document.getElementById('review-title');
            const reviewIncome = document.getElementById('review-income');
            const reviewExpenses = document.getElementById('review-expenses');
            const reviewSavings = document.getElementById('review-savings');
            const reviewAIAdvice = document.getElementById('review-ai-advice');
            const monthlyChartCanvas = document.getElementById('monthly-chart');
            let monthlyChart = null;
            const resetAppBtn = document.getElementById('reset-app-btn');
            const privacyOnBtn = document.getElementById('privacy-on-btn');
            const privacyOffBtn = document.getElementById('privacy-off-btn');
            const currencyEurBtn = document.getElementById('currency-eur-btn');
            const currencyUsdBtn = document.getElementById('currency-usd-btn');
            
            // Recurring Expense Toggles
            const recurringToggleAddWrapper = document.getElementById('recurring-toggle-add-wrapper');
            const recurringToggleAdd = document.getElementById('recurring-toggle-add');
            const recurringDayAddWrapper = document.getElementById('recurring-day-add-wrapper');
            const recurringDayAddInput = document.getElementById('recurring-day-add');
            
            const recurringToggleEditWrapper = document.getElementById('recurring-toggle-edit-wrapper');
            const recurringToggleEdit = document.getElementById('recurring-toggle-edit');
            const recurringDayEditWrapper = document.getElementById('recurring-day-edit-wrapper');
            const recurringDayEditInput = document.getElementById('recurring-day-edit');
            
            const recurringListContainer = document.getElementById('recurring-list-container');

            // Edit Modal Elements
            const editTransactionModal = document.getElementById('edit-transaction-modal');
            const closeEditTransactionModalBtn = document.getElementById('close-edit-transaction-modal');
            const editTransactionForm = document.getElementById('edit-transaction-form');
            const editTransactionIdInput = document.getElementById('edit-transaction-id');
            const editDescriptionInput = document.getElementById('edit-description');
            const editAmountInput = document.getElementById('edit-amount');
            const editRuleCategoryInput = document.getElementById('edit-rule-category');
            const editCategoryInput = document.getElementById('edit-category');
            const editExpenseFieldsWrapper = document.getElementById('edit-expense-fields-wrapper');


            // --- App State ---
            let userProfile = null;
            let transactions = [];
            let currentTransactionType = 'income';
            let exchangeRate = 1.08; // Default fallback

            // --- Data Management (localStorage) ---
            function loadData() {
                try {
                    const storedProfile = localStorage.getItem('klaroUserProfile');
                    const storedTransactions = localStorage.getItem('klaroTransactions');
                    if (storedProfile) {
                        userProfile = JSON.parse(storedProfile);
                        // Ensure new properties exist for older profiles
                        if (!userProfile.settings.recurringExpenses) {
                            userProfile.settings.recurringExpenses = [];
                        }
                        if (!userProfile.settings.lastRecurringCheck) {
                            // Set to yesterday to force a check on first load after update
                            const yesterday = new Date();
                            yesterday.setDate(yesterday.getDate() - 1);
                            userProfile.settings.lastRecurringCheck = yesterday.toDateString();
                        }
                        
                        transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
                        // Ensure transactions have Date objects
                        transactions.forEach(t => {
                            if (t.timestamp) t.timestamp = new Date(t.timestamp);
                        });
                        return true;
                    }
                } catch (e) {
                    console.error("Failed to load data from localStorage", e);
                }
                return false;
            }

            function saveData() {
                try {
                    localStorage.setItem('klaroUserProfile', JSON.stringify(userProfile));
                    localStorage.setItem('klaroTransactions', JSON.stringify(transactions));
                } catch (e) {
                    console.error("Failed to save data to localStorage", e);
                }
            }
            
            async function fetchExchangeRate() {
                try {
                    // Using a free, no-key-required API for simplicity
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const data = await response.json();
                    exchangeRate = data.rates.USD;
                } catch (error) {
                    console.error("Could not fetch exchange rate, using default 1:1.", error);
                    exchangeRate = 1.08; // A recent fallback
                }
            }

            // --- Initialization ---
            async function initializeApp() {
                await fetchExchangeRate();
                if (loadData()) {
                    onboardingView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    
                    applyTheme(userProfile.settings.theme);
                    applyLanguage(userProfile.settings.language, false); // Don't re-render here
                    applyPrivacyModeUI(userProfile.settings.privacyMode);
                    applyCurrencyUI(userProfile.settings.currency);
                    checkAndAddRecurringExpenses(); // Check on load
                    renderApp();
                } else {
                    appView.classList.add('hidden');
                    onboardingView.classList.remove('hidden');
                    updateOnboardingTip(); // Initial call
                }
            }

            function renderApp() {
                if (!userProfile) return;

                let welcomeText;
                if (userProfile.isFirstLogin) {
                    welcomeText = translations[userProfile.settings.language]?.welcome || 'Welcome, ';
                    userProfile.isFirstLogin = false;
                    saveData();
                } else {
                    welcomeText = translations[userProfile.settings.language]?.welcome_back || 'Welcome back, ';
                }
                
                welcomeMessage.textContent = welcomeText + (userProfile.name.split(' ')[0] || '');
                renderTransactions();
                updateSummaryAndBudget();
                setupMonthSelector();
                renderRecurringExpenses();
            }

            // --- Onboarding Logic ---
            const onboardingHabitTip = document.getElementById('onboarding-habit-tip');
            const onboardingGoalSelect = document.getElementById('onboarding-goal-select');
            const onboardingGoalDesc = document.getElementById('onboarding-goal-desc');

            function updateOnboardingTip() {
                if(!onboardingCurrency) return;
                const currency = onboardingCurrency.value;
                const amount = currency === 'EUR' ? '20€' : '$20';
                onboardingHabitTip.innerHTML = `Experts recommend setting aside **at least 10%** for savings and investments. Remember, even a small amount like ${amount} helps build a habit for a more secure future.`;
            }
            
            if(onboardingCurrency) {
                onboardingCurrency.addEventListener('change', updateOnboardingTip);
            }
            
            if(onboardingGoalSelect) {
                onboardingGoalSelect.addEventListener('change', () => {
                    if(onboardingGoalSelect.value === 'custom') {
                        onboardingGoalDesc.classList.remove('hidden');
                        onboardingGoalDesc.focus();
                    } else {
                        onboardingGoalDesc.classList.add('hidden');
                    }
                });
            }

            const onboardingSliders = {
                needs: document.getElementById('onboarding-needs-slider'),
                wants: document.getElementById('onboarding-wants-slider'),
                savings: document.getElementById('onboarding-savings-slider')
            };
            const onboardingSliderVals = {
                needs: document.getElementById('onboarding-needs-slider-val'),
                wants: document.getElementById('onboarding-wants-slider-val'),
                savings: document.getElementById('onboarding-savings-slider-val')
            };
            const onboardingSliderTotal = document.getElementById('onboarding-slider-total');

            function updateOnboardingSliderTotal(changedSlider) {
                if (!onboardingSliders.needs) return; // Guard clause
                
                let needs = parseInt(onboardingSliders.needs.value);
                let wants = parseInt(onboardingSliders.wants.value);
                let savings = parseInt(onboardingSliders.savings.value);
                
                let total = needs + wants + savings;
                let diff = total - 100;

                if (diff > 0) {
                    if (changedSlider === 'needs') {
                        let wantsShare = (wants + savings) === 0 ? 0.5 : wants / (wants + savings);
                        let savingsShare = (wants + savings) === 0 ? 0.5 : savings / (wants + savings);
                        onboardingSliders.wants.value = wants - Math.floor(diff * wantsShare);
                        onboardingSliders.savings.value = savings - Math.ceil(diff * savingsShare);
                    } else if (changedSlider === 'wants') {
                        let needsShare = (needs + savings) === 0 ? 0.5 : needs / (needs + savings);
                        let savingsShare = (needs + savings) === 0 ? 0.5 : savings / (needs + savings);
                        onboardingSliders.needs.value = needs - Math.floor(diff * needsShare);
                        onboardingSliders.savings.value = savings - Math.ceil(diff * savingsShare);
                    } else { // savings
                        let needsShare = (needs + wants) === 0 ? 0.5 : needs / (needs + wants);
                        let wantsShare = (needs + wants) === 0 ? 0.5 : wants / (needs + wants);
                        onboardingSliders.needs.value = needs - Math.floor(diff * needsShare);
                        onboardingSliders.wants.value = wants - Math.ceil(diff * wantsShare);
                    }
                }
                
                // Recalculate total after adjustments
                needs = parseInt(onboardingSliders.needs.value);
                wants = parseInt(onboardingSliders.wants.value);
                savings = parseInt(onboardingSliders.savings.value);
                total = needs + wants + savings;

                // Final adjustment if rounding caused mismatch
                if (total !== 100) {
                    let diff = 100 - total;
                    if (changedSlider !== 'needs') onboardingSliders.needs.value = needs + diff;
                    else if (changedSlider !== 'wants') onboardingSliders.wants.value = wants + diff;
                    else onboardingSliders.savings.value = savings + diff;
                }

                onboardingSliderVals.needs.textContent = onboardingSliders.needs.value;
                onboardingSliderVals.wants.textContent = onboardingSliders.wants.value;
                onboardingSliderVals.savings.textContent = onboardingSliders.savings.value;

                total = parseInt(onboardingSliders.needs.value) + parseInt(onboardingSliders.wants.value) + parseInt(onboardingSliders.savings.value);
                onboardingSliderTotal.textContent = `Total: ${total}%`;
                onboardingSliderTotal.style.color = total === 100 ? '#16a34a' : '#dc2626';
            }


            Object.keys(onboardingSliders).forEach(key => {
                const slider = onboardingSliders[key];
                 if(slider) {
                    slider.addEventListener('input', () => updateOnboardingSliderTotal(key));
                 }
            });

            if (onboardingForm) {
                onboardingForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    onboardingError.textContent = '';
                    const total = parseInt(onboardingSliders.needs.value) + parseInt(onboardingSliders.wants.value) + parseInt(onboardingSliders.savings.value);
                    if (total !== 100) {
                        onboardingError.textContent = 'Total must be exactly 100%.';
                        return;
                    }
                    
                    let goalDescription = onboardingGoalSelect.value;
                    if (goalDescription === 'custom') {
                        goalDescription = onboardingGoalDesc.value.trim();
                    }
                    
                    let goalAmount = parseFloat(document.getElementById('onboarding-goal-amount').value.replace(',', '.')) || 0;
                    let baseCurrency = onboardingCurrency.value;
                    
                    // Convert goal to EUR if set in USD
                    if (baseCurrency === 'USD') {
                        goalAmount = goalAmount / exchangeRate;
                    }

                    userProfile = {
                        name: document.getElementById('onboarding-name').value,
                        isFirstLogin: true,
                        settings: {
                            budget: {
                                needs: parseInt(onboardingSliders.needs.value),
                                wants: parseInt(onboardingSliders.wants.value),
                                savings: parseInt(onboardingSliders.savings.value),
                            },
                            goal: {
                                description: goalDescription,
                                amount: goalAmount, // Always store in EUR
                            },
                            theme: 'light',
                            language: 'en',
                            privacyMode: false,
                            currency: baseCurrency,
                            recurringExpenses: [],
                            lastRecurringCheck: new Date(0).toDateString() // Set to epoch to force check
                        }
                    };
                    
                    transactions = [];
                    saveData();
                    initializeApp();
                });
            }


            // --- Appearance & Language & Privacy & Currency ---
            function applyTheme(theme) {
                document.documentElement.classList.toggle('dark', theme === 'dark');
                themeLightBtn.classList.toggle('setting-btn-active', theme === 'light');
                themeDarkBtn.classList.toggle('setting-btn-active', theme === 'dark');
            }

            function applyLanguage(lang, shouldRender = true) {
                 document.querySelectorAll('[data-lang]').forEach(el => {
                    const key = el.dataset.lang;
                    const text = translations[lang]?.[key] || translations['en'][key];
                    if(text) el.textContent = text;
                });
                 document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                    const key = el.dataset.langPlaceholder;
                    const text = translations[lang]?.[key] || translations['en'][key];
                    if(text) el.placeholder = text;
                });
                langEnBtn.classList.toggle('setting-btn-active', lang === 'en');
                langHrBtn.classList.toggle('setting-btn-active', lang === 'hr');
                if (userProfile && userProfile.settings) {
                    applyCurrencyUI(userProfile.settings.currency);
                    if (shouldRender) {
                        renderApp();
                    }
                }
            }
            
            function applyPrivacyModeUI(isPrivate) {
                privacyOnBtn.classList.toggle('setting-btn-active', isPrivate);
                privacyOffBtn.classList.toggle('setting-btn-active', !isPrivate);
            }

            function applyCurrencyUI(currency) {
                currencyEurBtn.classList.toggle('setting-btn-active', currency === 'EUR');
                currencyUsdBtn.classList.toggle('setting-btn-active', currency === 'USD');
                if (userProfile && userProfile.settings) {
                    document.querySelectorAll('[data-lang="amount"]').forEach(el => {
                        const baseText = translations[userProfile.settings.language]?.amount || 'Amount';
                        el.textContent = `${baseText} (${currency === 'EUR' ? '€' : '$'})`;
                    });
                }
            }


            privacyOnBtn.addEventListener('click', () => {
                userProfile.settings.privacyMode = true;
                applyPrivacyModeUI(true);
                saveData();
                renderApp();
            });
            privacyOffBtn.addEventListener('click', () => {
                userProfile.settings.privacyMode = false;
                applyPrivacyModeUI(false);
                saveData();
                renderApp();
            });

            themeLightBtn.addEventListener('click', () => {
                userProfile.settings.theme = 'light';
                applyTheme('light');
                saveData();
            });
            themeDarkBtn.addEventListener('click', () => {
                userProfile.settings.theme = 'dark';
                applyTheme('dark');
                saveData();
            });
            langEnBtn.addEventListener('click', () => {
                userProfile.settings.language = 'en';
                saveData();
                applyLanguage('en');
            });
            langHrBtn.addEventListener('click', () => {
                userProfile.settings.language = 'hr';
                saveData();
                applyLanguage('hr');
            });
            currencyEurBtn.addEventListener('click', () => {
                userProfile.settings.currency = 'EUR';
                saveData();
                applyCurrencyUI('EUR');
                renderApp();
            });
            currencyUsdBtn.addEventListener('click', () => {
                userProfile.settings.currency = 'USD';
                saveData();
                applyCurrencyUI('USD');
                renderApp();
            });


            // --- Monthly Review, AI Functions, UI Listeners, etc. ---
            function setupMonthSelector() {
                const monthSet = new Set();
                transactions.forEach(t => {
                    if (t.timestamp) {
                        const date = t.timestamp;
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth()).padStart(2, '0')}`;
                        monthSet.add(monthKey);
                    }
                });

                if (monthSet.size === 0) {
                    monthlyReviewSection.classList.add('hidden');
                    return;
                }

                monthlyReviewSection.classList.remove('hidden');
                const currentSelection = monthSelector.value;
                monthSelector.innerHTML = '';
                const sortedMonths = Array.from(monthSet).sort().reverse();
                
                sortedMonths.forEach(monthKey => {
                    const [year, monthIndex] = monthKey.split('-');
                    const date = new Date(year, monthIndex);
                    const option = document.createElement('option');
                    option.value = monthKey;
                    option.textContent = date.toLocaleString(userProfile.settings.language === 'hr' ? 'hr-HR' : 'en-US', { month: 'long', year: 'numeric' });
                    monthSelector.appendChild(option);
                });
                
                if (currentSelection && monthSet.has(currentSelection)) {
                    monthSelector.value = currentSelection;
                } else {
                    monthSelector.value = sortedMonths[0] || '';
                }
                renderMonthlyReview(monthSelector.value);
            }

            if(monthSelector) {
                monthSelector.addEventListener('change', () => renderMonthlyReview(monthSelector.value));
            }

            async function renderMonthlyReview(monthKey) {
                 if (!monthKey) {
                    noReviewData.classList.remove('hidden');
                    monthlyReviewContent.classList.add('hidden');
                    return;
                }
                const [year, monthIndex] = monthKey.split('-').map(Number);
                
                const monthlyTransactions = transactions.filter(t => {
                    if(!t.timestamp) return false;
                    const date = t.timestamp;
                    return date.getFullYear() === year && date.getMonth() === monthIndex;
                });

                if (monthlyTransactions.length === 0) {
                    noReviewData.classList.remove('hidden');
                    monthlyReviewContent.classList.add('hidden');
                    return;
                }

                noReviewData.classList.add('hidden');
                monthlyReviewContent.classList.remove('hidden');

                const date = new Date(year, monthIndex);
                const reviewForText = translations[userProfile.settings.language].review_for || 'Review for';
                reviewTitle.textContent = `${reviewForText} ${date.toLocaleString(userProfile.settings.language === 'hr' ? 'hr-HR' : 'en-US', { month: 'long', year: 'numeric' })}`;

                const income = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const spentOnNeeds = monthlyTransactions.filter(t => t.ruleCategory === 'Needs').reduce((s, t) => s + t.amount, 0);
                const spentOnWants = monthlyTransactions.filter(t => t.ruleCategory === 'Wants').reduce((s, t) => s + t.amount, 0);
                const amountSaved = monthlyTransactions.filter(t => t.ruleCategory === 'Savings').reduce((s, t) => s + t.amount, 0);
                const net = income - expenses;
                
                reviewIncome.innerHTML = getDisplayValue(income);
                reviewExpenses.innerHTML = getDisplayValue(expenses);
                reviewSavings.innerHTML = getDisplayValue(net);
                reviewSavings.className = net >= 0 ? 'font-medium text-green-600' : 'font-medium text-red-600';
                
                const chartData = {
                    labels: [translations[userProfile.settings.language].needs, translations[userProfile.settings.language].wants, translations[userProfile.settings.language].savings],
                    datasets: [{
                        data: [spentOnNeeds, spentOnWants, amountSaved],
                        backgroundColor: ['#2563eb', '#9333ea', '#16a34a'],
                        hoverOffset: 4
                    }]
                };

                if (monthlyChart) {
                    monthlyChart.destroy();
                }
                monthlyChart = new Chart(monthlyChartCanvas, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top', labels: { color: userProfile.settings.theme === 'dark' ? '#f9fafb' : '#6b7280' } },
                            title: { display: false }
                        }
                    }
                });

                const monthlyExpensesList = monthlyTransactions.filter(t => t.type === 'expense');
                const numberOfExpenses = monthlyExpensesList.length;
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonthIndex = now.getMonth();
                const isPastMonth = year < currentYear || (year === currentYear && monthIndex < currentMonthIndex);

                if (income > 0 && (numberOfExpenses >= 10 || isPastMonth)) {
                    reviewAIAdvice.innerHTML = '<p>Generating AI analysis...</p>';
                    const advice = await getAIMonthlyAdvice({income, spentOnNeeds, spentOnWants, amountSaved, month: date.toLocaleString('default', { month: 'long' })});
                    reviewAIAdvice.innerHTML = advice;
                } else if (income === 0) {
                     reviewAIAdvice.innerHTML = `<p class="text-sm text-gray-500">Add an income for this month to get a full analysis.</p>`;
                } else {
                    reviewAIAdvice.innerHTML = `<p class="text-sm text-gray-500">Enter at least ${10 - numberOfExpenses} more expense(s) this month to receive your personalized AI analysis.</p>`;
                }
            }

            async function getAIMonthlyAdvice(data) {
                 if (isNaN(data.income) || isNaN(data.spentOnNeeds) || isNaN(data.spentOnWants) || isNaN(data.amountSaved)) {
                    console.error("Invalid data passed to getAIMonthlyAdvice:", data);
                    return "<p>Could not generate advice due to invalid data.</p>";
                }
                
                let convertedData = { ...data };
                let goalAmount = userProfile.settings.goal.amount;
                if (userProfile.settings.currency === 'USD') {
                    convertedData.income *= exchangeRate;
                    convertedData.spentOnNeeds *= exchangeRate;
                    convertedData.spentOnWants *= exchangeRate;
                    convertedData.amountSaved *= exchangeRate;
                    goalAmount *= exchangeRate;
                }

                 const prompt = `Here is my financial summary in ${userProfile.settings.currency} for ${data.month}:
                - Total Income: ${convertedData.income.toFixed(2)}
                - Spending on Needs: ${convertedData.spentOnNeeds.toFixed(2)}
                - Spending on Wants: ${convertedData.spentOnWants.toFixed(2)}
                - Total Saved (from transactions categorized as savings): ${convertedData.amountSaved.toFixed(2)}
                - My budget rule is roughly: Needs (${userProfile.settings.budget.needs}%), Wants (${userProfile.settings.budget.wants}%), Savings (${userProfile.settings.budget.savings}%)
                - My long-term goal is: "${userProfile.settings.goal.description || 'general savings'}" for ${goalAmount.toFixed(2)} ${userProfile.settings.currency}.

                Provide a concise, motivating report. Start by highlighting one positive achievement. Then, gently point out one area for potential improvement with a practical tip. End with an encouraging sentence for the month ahead.`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: `You are a friendly and encouraging financial coach. Your core philosophy is 'Save for your future self'. Your advice must be in ${userProfile.settings.language === 'hr' ? 'Croatian' : 'English'}. Respond with simple HTML paragraphs (<p>).` }] }
                };
                 try {
                    const response = await fetch(GEMINI_API_URL + apiKey, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error('API Error');
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "<p>Could not generate advice at this time.</p>";
                } catch (error) {
                    console.error("AI Monthly Advice failed:", error);
                    return "<p>Error generating your financial advice.</p>";
                }
            }

            function getAIFinancialPlan() {
                 if (!userProfile || !userProfile.settings) return;

                const { goal, budget, language, currency } = userProfile.settings;

                if (!goal || !goal.description || !goal.amount || goal.amount <= 0) {
                     tipsContent.innerHTML = `<p data-lang="set_goal_prompt">${translations[language]?.set_goal_prompt || translations.en.set_goal_prompt}</p>`;
                     return;
                 }
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                
                if (totalIncome === 0) {
                    tipsSection.classList.add('hidden');
                    return;
                }
                
                tipsSection.classList.remove('hidden');

                const amountSaved = transactions.filter(t => t.ruleCategory === 'Savings').reduce((s, t) => s + t.amount, 0);
                const savingsTarget = totalIncome * (budget.savings / 100);
                const progressPercentage = savingsTarget > 0 ? (amountSaved / savingsTarget) * 100 : 0;
                
                let motivationalMessage = '';
                
                if (progressPercentage >= 100) {
                    motivationalMessage = language === 'hr' ? 'Odlično! Ispunili ste svoj mjesečni cilj štednje. Svaki dodatni euro je bonus za vaše buduće ja.' : "Excellent! You've met your savings goal for the month. Every extra bit is a bonus for your future self.";
                } else if (progressPercentage >= 50) {
                    motivationalMessage = language === 'hr' ? `Sjajan posao! Već ste na pola puta do svog mjesečnog cilja. Samo tako nastavite!` : "Great job! You're already halfway to your monthly goal. Keep up the momentum!";
                } else if (progressPercentage > 0) {
                    motivationalMessage = language === 'hr' ? 'Napravili ste odličan početak! Svaki doprinos, velik ili mali, gradi snažniju financijsku budućnost.' : "You've made a great start! Every contribution, big or small, builds a stronger financial future.";
                } else {
                    motivationalMessage = language === 'hr' ? 'Spremni za početak štednje? Sjetite se pravila "Prvo platite sebi".' : "Ready to start saving? Remember the 'Pay Yourself First' rule.";
                }
                
                const tip = language === 'hr' ? 'Nakon što primite plaću, odmah prebacite planirani iznos na štednju. Tako uistinu prvo plaćate sebi.' : "After you get paid, transfer your planned savings immediately. That's how you truly pay yourself first.";

                const progressText = translations[language]?.progress || 'Progress';
                tipsContent.innerHTML = `<p>${motivationalMessage} <strong class="whitespace-nowrap">${progressText}: ${progressPercentage.toFixed(0)}%</strong></p><p class="italic mt-2 text-xs"><strong>Tip:</strong> ${tip}</p>`;
            }

            function setTransactionType(type) {
                currentTransactionType = type;
                typeIncomeBtn.classList.toggle('tab-active', type === 'income');
                typeIncomeBtn.classList.toggle('tab-inactive', type !== 'income');
                typeExpenseBtn.classList.toggle('tab-active', type === 'expense');
                typeExpenseBtn.classList.toggle('tab-inactive', type !== 'expense');
                expenseFieldsWrapper.classList.toggle('hidden', type === 'income');
                recurringToggleAddWrapper.classList.toggle('hidden', type === 'income');
                
                if (type === 'expense') {
                    updateSubCategoryOptions(ruleCategoryInput, categoryInput);
                } else {
                    // Hide recurring options if switching to income
                    recurringToggleAdd.checked = false;
                    recurringDayAddWrapper.classList.add('hidden');
                }
            }
            
            function updateSubCategoryOptions(ruleSelect, categorySelect) {
                const selectedRule = ruleSelect.value;
                const options = subCategoryMap[selectedRule] || [];

                categorySelect.innerHTML = ''; // Clear existing options

                options.forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    categorySelect.appendChild(option);
                });
            }

            function populateDaySelect(selectElement) {
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    selectElement.appendChild(option);
                }
            }
            
            populateDaySelect(recurringDayAddInput);
            populateDaySelect(recurringDayEditInput);

            ruleCategoryInput.addEventListener('change', () => updateSubCategoryOptions(ruleCategoryInput, categoryInput));

            recurringToggleAdd.addEventListener('change', () => {
                recurringDayAddWrapper.classList.toggle('hidden', !recurringToggleAdd.checked);
            });
            
            recurringToggleEdit.addEventListener('change', () => {
                recurringDayEditWrapper.classList.toggle('hidden', !recurringToggleEdit.checked);
            });


            typeIncomeBtn.addEventListener('click', () => setTransactionType('income'));
            typeExpenseBtn.addEventListener('click', () => setTransactionType('expense'));

            transactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const descriptionVal = descriptionInput.value.trim();
                let amountVal = parseFloat(document.getElementById('amount').value.replace(',', '.'));
                if (!descriptionVal || isNaN(amountVal) || amountVal <= 0) return;

                // Convert to base currency (EUR) if user is entering in USD
                if (userProfile.settings.currency === 'USD') {
                    amountVal = amountVal / exchangeRate;
                }

                const newTransaction = { 
                    id: Date.now().toString(),
                    type: currentTransactionType, 
                    description: descriptionVal, 
                    amount: amountVal, // Always save in EUR
                    timestamp: new Date()
                };

                const isRecurring = recurringToggleAdd.checked;
                const dayOfMonth = parseInt(recurringDayAddInput.value);

                if (currentTransactionType === 'expense') {
                    newTransaction.category = categoryInput.value;
                    newTransaction.ruleCategory = ruleCategoryInput.value;

                    if (isRecurring && !isNaN(dayOfMonth) && dayOfMonth >= 1 && dayOfMonth <= 31) {
                        const recurringId = Date.now().toString() + '_recur';
                        newTransaction.recurringId = recurringId;
                        const newRecurringExpense = {
                            id: recurringId,
                            description: descriptionVal,
                            amount: amountVal,
                            dayOfMonth: dayOfMonth,
                            ruleCategory: ruleCategoryInput.value,
                            category: categoryInput.value
                        };
                        userProfile.settings.recurringExpenses.push(newRecurringExpense);
                    }
                }
                
                transactions.unshift(newTransaction);
                saveData();
                
                if (currentTransactionType === 'income') { setTransactionType('expense'); }
                
                descriptionInput.value = '';
                document.getElementById('amount').value = '';
                recurringToggleAdd.checked = false;
                recurringDayAddWrapper.classList.add('hidden');
                recurringDayAddInput.value = '1';

                renderApp();
            });

            transactionListEl.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                if (deleteButton) { 
                    const transactionId = deleteButton.dataset.id;
                    transactions = transactions.filter(t => t.id !== transactionId);
                    saveData();
                    renderApp();
                }

                const editButton = e.target.closest('.edit-btn');
                if (editButton) {
                    const transactionId = editButton.dataset.id;
                    openEditModal(transactionId);
                }
            });

            const formatCurrency = (value) => {
                const lang = userProfile?.settings.language === 'hr' ? 'hr-HR' : 'en-US'; 
                const currency = userProfile?.settings.currency || 'EUR';
                
                let displayValue = value;
                // All stored values are in EUR (base currency)
                if (currency === 'USD') {
                    displayValue = value * exchangeRate;
                }

                return new Intl.NumberFormat(lang, { style: 'currency', currency: currency }).format(displayValue);
            }
            
            const getDisplayValue = (value) => {
                if (userProfile?.settings.privacyMode) {
                    return `<span>***</span> <button class="reveal-amount-btn" data-amount="${value}">
                        <svg class="w-5 h-5 inline-block text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    </button>`;
                }
                return formatCurrency(value);
            };

            function renderTransactions() {
                const now = new Date();
                const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const currentMonthTransactions = transactions.filter(t => t.timestamp && t.timestamp >= currentMonthStart);

                if (currentMonthTransactions.length === 0) {
                    emptyState.style.display = 'block';
                    transactionListEl.innerHTML = '';
                    transactionListEl.appendChild(emptyState);
                    return;
                }
                emptyState.style.display = 'none';
                transactionListEl.innerHTML = currentMonthTransactions.map(t => {
                    const isIncome = t.type === 'income';
                    const isRecurring = t.recurringId && userProfile.settings.recurringExpenses.some(r => r.id === t.recurringId);
                    
                    return `
                        <div class="flex items-center p-4 border-b border-gray-200 last:border-b-0">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${isIncome ? 'bg-green-100' : (t.ruleCategory === 'Savings' ? 'bg-green-100' : 'bg-red-100')} dark:bg-opacity-10">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${isIncome ? 'text-green-600' : (t.ruleCategory === 'Savings' ? 'text-green-600' : 'text-red-600')}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isIncome ? 'M12 4v16m8-8H4' : 'M20 12H4'}" /></svg>
                            </div>
                            <div class="flex-1 min-w-0 mx-4">
                                <p class="font-semibold text-gray-800 truncate">${t.description}</p>
                                <div class="flex items-center space-x-2">
                                    <p class="text-sm text-gray-500">${isIncome ? (translations[userProfile.settings.language].income || 'Income') : `${t.category} (${t.ruleCategory})`}</p>
                                    ${isRecurring ? `<svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2.086a8.001 8.001 0 00-11.99 0M20 20v-5h-.582m-15.356-2.086a8.001 8.001 0 0011.99 0"></path></svg>` : ''}
                                </div>
                            </div>
                            <div class="text-right flex items-center">
                                <p class="font-bold text-lg whitespace-nowrap ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'}${getDisplayValue(t.amount)}</p>
                                <button data-id="${t.id}" class="edit-btn p-1 ml-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                                </button>
                                <button data-id="${t.id}" class="delete-btn p-1 rounded-full hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
                                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function updateSummaryAndBudget() {
                if (!userProfile) return;
                const now = new Date();
                const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const currentMonthTransactions = transactions.filter(t => t.timestamp && t.timestamp >= currentMonthStart);
                const totalIncome = currentMonthTransactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                const totalExpenses = currentMonthTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                
                totalIncomeEl.innerHTML = getDisplayValue(totalIncome);
                totalExpensesEl.innerHTML = getDisplayValue(totalExpenses);
                balanceEl.innerHTML = getDisplayValue(totalIncome - totalExpenses);

                const needsBudget = totalIncome * (userProfile.settings.budget.needs / 100);
                const wantsBudget = totalIncome * (userProfile.settings.budget.wants / 100);
                const savingsTarget = totalIncome * (userProfile.settings.budget.savings / 100);
                const spentOnNeeds = currentMonthTransactions.filter(t => t.ruleCategory === 'Needs').reduce((s, t) => s + t.amount, 0);
                const spentOnWants = currentMonthTransactions.filter(t => t.ruleCategory === 'Wants').reduce((s, t) => s + t.amount, 0);
                const amountSaved = currentMonthTransactions.filter(t => t.ruleCategory === 'Savings').reduce((s, t) => s + t.amount, 0);

                needsTitleEl.textContent = `${translations[userProfile.settings.language].needs} (${userProfile.settings.budget.needs}%)`;
                wantsTitleEl.textContent = `${translations[userProfile.settings.language].wants} (${userProfile.settings.budget.wants}%)`;
                savingsTitleEl.textContent = `${translations[userProfile.settings.language].savings} (${userProfile.settings.budget.savings}%)`;

                needsSummaryEl.innerHTML = `${getDisplayValue(spentOnNeeds)} / ${getDisplayValue(needsBudget)}`;
                wantsSummaryEl.innerHTML = `${getDisplayValue(spentOnWants)} / ${getDisplayValue(wantsBudget)}`;
                savingsSummaryEl.innerHTML = `${getDisplayValue(amountSaved)} / ${getDisplayValue(savingsTarget)}`;
                
                const needsPercentNum = needsBudget > 0 ? (spentOnNeeds / needsBudget) * 100 : 0;
                const wantsPercentNum = wantsBudget > 0 ? (spentOnWants / wantsBudget) * 100 : 0;
                const savingsPercentNum = savingsTarget > 0 ? (amountSaved / savingsTarget) * 100 : 0;

                needsBarEl.style.width = `${Math.min(needsPercentNum, 100)}%`;
                wantsBarEl.style.width = `${Math.min(wantsPercentNum, 100)}%`;
                savingsBarEl.style.width = `${Math.min(savingsPercentNum, 100)}%`;

                const progressText = translations[userProfile.settings.language]?.progress || 'Progress';
                
                if (userProfile.settings.privacyMode) {
                    needsProgressEl.textContent = `${progressText}: ***%`;
                    wantsProgressEl.textContent = `${progressText}: ***%`;
                    savingsProgressEl.textContent = `${progressText}: ***%`;
                } else {
                    needsProgressEl.textContent = `${progressText}: ${needsPercentNum.toFixed(0)}%`;
                    wantsProgressEl.textContent = `${progressText}: ${wantsPercentNum.toFixed(0)}%`;
                    savingsProgressEl.textContent = `${progressText}: ${savingsPercentNum.toFixed(0)}%`;
                }

                getAIFinancialPlan();
            }
            
            // --- Modal Logic ---
            const toggleModal = (modal) => {
                modal.classList.toggle('hidden');
                if (!modal.classList.contains('hidden')) {
                    modal.classList.add('modal-active');
                    setTimeout(() => { modal.querySelector('.modal-content').style.transform = 'translateY(0)'; }, 10);
                } else {
                     modal.querySelector('.modal-content').style.transform = 'translateY(-16rem)';
                     setTimeout(() => modal.classList.remove('modal-active'), 250);
                }
            };

            settingsBtn.addEventListener('click', () => toggleModal(settingsModal));
            closeSettingsModalBtn.addEventListener('click', () => toggleModal(settingsModal));

            // --- Edit Modal Logic ---
            function openEditModal(transactionId) {
                const transaction = transactions.find(t => t.id === transactionId);
                if (!transaction) return;

                editTransactionIdInput.value = transaction.id;
                editDescriptionInput.value = transaction.description;
                
                let displayAmount = transaction.amount;
                if (userProfile.settings.currency === 'USD') {
                    displayAmount = transaction.amount * exchangeRate;
                }
                editAmountInput.value = displayAmount.toFixed(2);
                
                if (transaction.type === 'expense') {
                    editExpenseFieldsWrapper.style.display = 'grid';
                    recurringToggleEditWrapper.classList.remove('hidden');
                    editRuleCategoryInput.value = transaction.ruleCategory;
                    updateSubCategoryOptions(editRuleCategoryInput, editCategoryInput); // Update sub-categories
                    editCategoryInput.value = transaction.category;
                    
                    // Check and set recurring status
                    const recurringData = userProfile.settings.recurringExpenses.find(r => r.id === transaction.recurringId);
                    if (recurringData) {
                        recurringToggleEdit.checked = true;
                        recurringDayEditWrapper.classList.remove('hidden');
                        recurringDayEditInput.value = recurringData.dayOfMonth;
                    } else {
                        recurringToggleEdit.checked = false;
                        recurringDayEditWrapper.classList.add('hidden');
                        recurringDayEditInput.value = '1';
                    }
                } else {
                    editExpenseFieldsWrapper.style.display = 'none';
                    recurringToggleEditWrapper.classList.add('hidden');
                }

                toggleModal(editTransactionModal);
            }
            
            editRuleCategoryInput.addEventListener('change', () => updateSubCategoryOptions(editRuleCategoryInput, editCategoryInput));
            closeEditTransactionModalBtn.addEventListener('click', () => toggleModal(editTransactionModal));

            editTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const transactionId = editTransactionIdInput.value;
                const transactionIndex = transactions.findIndex(t => t.id === transactionId);
                if (transactionIndex === -1) return;

                let amountVal = parseFloat(editAmountInput.value.replace(',', '.'));
                if (userProfile.settings.currency === 'USD') {
                    amountVal = amountVal / exchangeRate; // Convert back to EUR for storage
                }

                const updatedTransaction = {
                    ...transactions[transactionIndex],
                    description: editDescriptionInput.value,
                    amount: amountVal
                };
                
                const isRecurring = recurringToggleEdit.checked;
                const dayOfMonth = parseInt(recurringDayEditInput.value);
                const existingRecurringIndex = userProfile.settings.recurringExpenses.findIndex(r => r.id === updatedTransaction.recurringId);

                if (updatedTransaction.type === 'expense') {
                    updatedTransaction.ruleCategory = editRuleCategoryInput.value;
                    updatedTransaction.category = editCategoryInput.value;

                    if (isRecurring && !isNaN(dayOfMonth) && dayOfMonth >= 1 && dayOfMonth <= 31) {
                        const recurringData = { 
                            id: updatedTransaction.recurringId || Date.now().toString() + '_recur',
                            description: updatedTransaction.description,
                            amount: updatedTransaction.amount,
                            dayOfMonth: dayOfMonth,
                            ruleCategory: updatedTransaction.ruleCategory,
                            category: updatedTransaction.category
                        };

                        if (existingRecurringIndex > -1) {
                            // It was already recurring, just update it
                            userProfile.settings.recurringExpenses[existingRecurringIndex] = recurringData;
                        } else {
                            // It's a newly recurring item
                            updatedTransaction.recurringId = recurringData.id;
                            userProfile.settings.recurringExpenses.push(recurringData);
                        }
                    } else {
                        // Toggle is OFF
                        if (existingRecurringIndex > -1) {
                            // It *was* recurring, but isn't anymore
                            userProfile.settings.recurringExpenses.splice(existingRecurringIndex, 1);
                            delete updatedTransaction.recurringId; // Clean the transaction
                        }
                    }
                }

                transactions[transactionIndex] = updatedTransaction;
                saveData();
                renderApp();
                toggleModal(editTransactionModal);
            });


            resetAppBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to reset all app data? This cannot be undone.')) {
                    localStorage.removeItem('klaroUserProfile');
                    localStorage.removeItem('klaroTransactions');
                    window.location.reload();
                }
            });
            
            // --- Recurring Expenses Logic ---
            function getNextPaymentDate(exp) {
                const now = new Date();
                let paymentDate = new Date(now.getFullYear(), now.getMonth(), exp.dayOfMonth);

                // Adjust for weekend
                const dayOfWeek = paymentDate.getDay();
                if (dayOfWeek === 6) { // Saturday
                    paymentDate.setDate(paymentDate.getDate() + 2);
                } else if (dayOfWeek === 0) { // Sunday
                    paymentDate.setDate(paymentDate.getDate() + 1);
                }

                // If this month's adjusted payment date has already passed, set for next month
                if (paymentDate < now) {
                    paymentDate = new Date(now.getFullYear(), now.getMonth() + 1, exp.dayOfMonth);
                    // Re-check weekend for next month
                    const nextMonthDayOfWeek = paymentDate.getDay();
                    if (nextMonthDayOfWeek === 6) { // Saturday
                        paymentDate.setDate(paymentDate.getDate() + 2);
                    } else if (nextMonthDayOfWeek === 0) { // Sunday
                        paymentDate.setDate(paymentDate.getDate() + 1);
                    }
                }
                return paymentDate;
            }

            recurringListContainer.addEventListener('click', (e) => {
                if (e.target.closest('.delete-recurring-btn')) {
                    const id = e.target.closest('.delete-recurring-btn').dataset.id;
                    userProfile.settings.recurringExpenses = userProfile.settings.recurringExpenses.filter(exp => exp.id !== id);
                    
                    // Also remove recurringId from any transactions that might have it
                    transactions.forEach(t => {
                        if (t.recurringId === id) {
                            delete t.recurringId;
                        }
                    });

                    saveData();
                    renderRecurringExpenses();
                }
            });

            function renderRecurringExpenses() {
                recurringListContainer.innerHTML = '';
                if (!userProfile || !userProfile.settings.recurringExpenses || userProfile.settings.recurringExpenses.length === 0) {
                    recurringListContainer.innerHTML = `<p class="text-sm text-gray-500" data-lang="no_recurring_expenses">${translations[userProfile.settings.language]?.no_recurring_expenses || 'No recurring expenses set up yet.'}</p>`;
                    return;
                }

                userProfile.settings.recurringExpenses.forEach(exp => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-800 rounded-md";
                    
                    const nextPaymentDate = getNextPaymentDate(exp);
                    const formattedDate = nextPaymentDate.toLocaleDateString(userProfile.settings.language === 'hr' ? 'hr-HR' : 'en-US', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const nextPaymentText = translations[userProfile.settings.language]?.next_payment_on || 'Next payment on';

                    el.innerHTML = `
                        <div>
                            <p class="font-semibold">${exp.description} (${getDisplayValue(exp.amount)})</p>
                            <p class="text-sm text-gray-500">${nextPaymentText}: ${formattedDate}</p>
                        </div>
                        <button type="button" data-id="${exp.id}" class="delete-recurring-btn p-1 rounded-full hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors">
                            <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    recurringListContainer.appendChild(el);
                });
            }
            
            function checkAndAddRecurringExpenses() {
                const now = new Date();
                const todayStr = now.toDateString();
                const todayDay = now.getDate();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                if (userProfile.settings.lastRecurringCheck === todayStr) {
                    return; // Already checked today
                }
                
                let expensesAdded = false;
                userProfile.settings.recurringExpenses.forEach(exp => {
                    
                    let paymentDate = new Date(currentYear, currentMonth, exp.dayOfMonth);
                    let dayOfWeek = paymentDate.getDay();

                    if (dayOfWeek === 6) { // Saturday
                        paymentDate.setDate(paymentDate.getDate() + 2);
                    } else if (dayOfWeek === 0) { // Sunday
                        paymentDate.setDate(paymentDate.getDate() + 1);
                    }

                    // Check if the adjusted payment day is today
                    if (paymentDate.getDate() === todayDay && paymentDate.getMonth() === currentMonth) {
                        const alreadyAdded = transactions.some(t => 
                            t.recurringId === exp.id &&
                            t.timestamp.getFullYear() === currentYear &&
                            t.timestamp.getMonth() === currentMonth
                        );
                        
                        if (!alreadyAdded) {
                            const newTransaction = {
                                id: Date.now().toString() + exp.id,
                                type: 'expense',
                                description: exp.description,
                                amount: exp.amount,
                                timestamp: paymentDate, // Use the adjusted payment date
                                category: exp.category,
                                ruleCategory: exp.ruleCategory,
                                recurringId: exp.id // Link to recurring expense
                            };
                            transactions.unshift(newTransaction);
                            expensesAdded = true;
                        }
                    }
                });

                if (expensesAdded) {
                    saveData();
                }
                
                // Mark as checked for today
                userProfile.settings.lastRecurringCheck = todayStr;
                saveData();
            }


            // --- Privacy Reveal Logic ---
            document.body.addEventListener('click', (e) => {
                const revealBtn = e.target.closest('.reveal-amount-btn');
                if (revealBtn) {
                    const amount = parseFloat(revealBtn.dataset.amount);
                    const amountContainer = revealBtn.previousElementSibling;
                    if (amountContainer) {
                        const originalText = amountContainer.textContent;
                        amountContainer.textContent = formatCurrency(amount);
                        setTimeout(() => {
                            amountContainer.textContent = originalText;
                        }, 2000);
                    }
                }

                const revealSummaryBtn = e.target.closest('.reveal-summary-btn');
                if (revealSummaryBtn) {
                    const spent = parseFloat(revealSummaryBtn.dataset.spent);
                    const budget = parseFloat(revealSummaryBtn.dataset.budget);
                    const amountContainer = revealSummaryBtn.previousElementSibling;
                    if (amountContainer) {
                        const originalText = amountContainer.textContent; // "*** / ***"
                        amountContainer.textContent = `${formatCurrency(spent)} / ${formatCurrency(budget)}`;
                        setTimeout(() => {
                            amountContainer.textContent = originalText;
                        }, 2000);
                    }
                }
            });

            // --- Initial Load ---
            initializeApp();
        });
    </script>
</body>
</html>
